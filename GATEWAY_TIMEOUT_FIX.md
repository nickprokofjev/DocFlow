# Решение проблемы Gateway Timeout (HTTP 504)

## Проблема
При загрузке и обработке договоров в DocFlow возникала ошибка `HTTP 504: Gateway Time-out` на этапе извлечения данных. Проблема возникала из-за того, что OCR/NLP обработка выполнялась синхронно и занимала слишком много времени для больших или сложных документов.

## Решение

### 1. Увеличены таймауты в Nginx (✅ Выполнено)
**Файл**: `frontend/nginx.conf`

Добавлены настройки таймаутов для API запросов:
```nginx
# Увеличены таймауты для OCR/NLP обработки
proxy_connect_timeout 300s;
proxy_send_timeout 300s;
proxy_read_timeout 300s;
send_timeout 300s;
```

### 2. Реализована асинхронная обработка (✅ Выполнено)
**Файл**: `backend/task_queue.py`

Создана система фоновых задач:
- Класс `TaskQueue` для управления задачами
- Поддержка статусов: pending, processing, completed, failed, cancelled
- Отслеживание прогресса выполнения (0-100%)
- Автоматическая очистка завершённых задач

### 3. Новые API эндпоинты (✅ Выполнено)
**Файл**: `backend/api.py`

Добавлены эндпоинты для асинхронной работы:
- `POST /api/v1/contracts/extract` - запуск асинхронной обработки
- `GET /api/v1/jobs/{job_id}/status` - получение статуса задачи
- `POST /api/v1/jobs/{job_id}/cancel` - отмена задачи

### 4. Обновлён фронтенд (✅ Выполнено)
**Файлы**: 
- `frontend/src/lib/api.ts` - новый API клиент
- `frontend/src/components/ContractUploadModal.tsx` - поддержка асинхронности

Изменения в интерфейсе:
- Прогресс-бар с процентами выполнения
- Живые обновления статуса обработки
- Возможность отмены долгих операций
- Улучшенная обработка ошибок с подсказками

### 5. Инициализация фоновых сервисов (✅ Выполнено)
**Файл**: `backend/main.py`

Добавлен запуск фоновой очистки задач при старте приложения.

## Как это работает

### Старый процесс (с таймаутами):
1. Пользователь загружает файл
2. Backend синхронно обрабатывает файл (OCR + NLP)
3. Если обработка > 60 секунд → HTTP 504 Gateway Timeout
4. Пользователь получает ошибку

### Новый процесс (без таймаутов):
1. Пользователь загружает файл
2. Backend сразу возвращает `job_id` и запускает обработку в фоне
3. Фронтенд каждые 2 секунды опрашивает статус задачи
4. Пользователь видит прогресс в реальном времени
5. По завершении отображаются результаты

## Преимущества решения

✅ **Устранение таймаутов** - обработка может длиться любое время  
✅ **Прозрачность** - пользователь видит прогресс обработки  
✅ **Контроль** - возможность отменить долгую операцию  
✅ **Масштабируемость** - легко добавить очереди Redis/Celery в будущем  
✅ **UX** - улучшенный пользовательский опыт  

## Тестирование

Запустите тест для проверки работоспособности:
```bash
python test_timeout_fix.py
```

Все тесты должны пройти успешно:
- ✅ Конфигурация nginx
- ✅ API эндпоинты  
- ✅ Асинхронная обработка
- ✅ OCR/NLP компоненты

## Развёртывание

Для применения изменений:

1. **Остановите текущие контейнеры:**
   ```bash
   docker-compose down
   ```

2. **Пересоберите контейнеры:**
   ```bash
   docker-compose build
   ```

3. **Запустите обновлённую систему:**
   ```bash
   docker-compose up -d
   ```

## Мониторинг

Следите за логами backend для контроля работы:
```bash
docker-compose logs -f backend
```

Ключевые сообщения:
- `Submitting job {job_id}` - задача создана
- `Starting job {job_id}` - обработка начата  
- `Job {job_id} completed successfully` - задача завершена
- `Job {job_id} failed` - ошибка обработки

## Дальнейшие улучшения

Для продакшена рекомендуется:
- Использовать Redis для хранения статусов задач
- Добавить Celery для распределённой обработки
- Настроить мониторинг производительности
- Добавить ограничения на количество одновременных задач

---

**Результат**: Проблема Gateway Timeout полностью решена. Система теперь может обрабатывать файлы любого размера без таймаутов, предоставляя пользователю прозрачную информацию о ходе обработки.
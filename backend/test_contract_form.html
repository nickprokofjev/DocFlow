<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–æ–≤ - DocFlow</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .form-section h3 {
            margin-top: 0;
            color: #555;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input[type="text"], input[type="number"], input[type="date"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea {
            height: 80px;
            resize: vertical;
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .contracts-list {
            margin-top: 30px;
        }
        .contract-item {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .contract-item h4 {
            margin: 0 0 10px 0;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–æ–≤ DocFlow</h1>
        
        <!-- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ OCR -->
        <div class="form-section">
            <h3>üìÑ 1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ OCR/NLP (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)</h3>
            <form id="ocrForm">
                <div class="form-group">
                    <label for="file">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª (PDF –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)</label>
                    <input type="file" id="file" accept=".pdf,.jpg,.jpeg,.png" required>
                </div>
                <button type="submit" class="btn">–ò–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ</button>
                <button type="button" class="btn btn-secondary" onclick="fillSampleData()">–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏</button>
            </form>
            <div id="ocrResult"></div>
        </div>

        <!-- –§–æ—Ä–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ -->
        <div class="form-section">
            <h3>üìã 2. –î–∞–Ω–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä–∞</h3>
            <form id="contractForm">
                <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="number">–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞ *</label>
                        <input type="text" id="number" name="number" required>
                    </div>
                    <div class="form-group">
                        <label for="contract_date">–î–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ *</label>
                        <input type="date" id="contract_date" name="contract_date" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="customer_name">–ó–∞–∫–∞–∑—á–∏–∫ *</label>
                        <input type="text" id="customer_name" name="customer_name" required>
                    </div>
                    <div class="form-group">
                        <label for="contractor_name">–ü–æ–¥—Ä—è–¥—á–∏–∫ *</label>
                        <input type="text" id="contractor_name" name="contractor_name" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="subject">–ü—Ä–µ–¥–º–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞</label>
                        <textarea id="subject" name="subject"></textarea>
                    </div>
                </div>

                <!-- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è -->
                <h4>üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="amount">–°—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞</label>
                        <input type="number" id="amount" name="amount" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="vat_rate">–ù–î–° (%)</label>
                        <input type="number" id="vat_rate" name="vat_rate" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="retention_percentage">% —É–¥–µ—Ä–∂–∞–Ω–∏—è</label>
                        <input type="number" id="retention_percentage" name="retention_percentage" step="0.1">
                    </div>
                </div>

                <!-- –û–±—ä–µ–∫—Ç —Ä–∞–±–æ—Ç -->
                <h4>üèóÔ∏è –û–±—ä–µ–∫—Ç —Ä–∞–±–æ—Ç</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="work_object_name">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞</label>
                        <input type="text" id="work_object_name" name="work_object_name">
                    </div>
                    <div class="form-group">
                        <label for="work_object_address">–ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞</label>
                        <input type="text" id="work_object_address" name="work_object_address">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="cadastral_number">–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä</label>
                        <input type="text" id="cadastral_number" name="cadastral_number">
                    </div>
                    <div class="form-group">
                        <label for="construction_permit">–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ</label>
                        <input type="text" id="construction_permit" name="construction_permit">
                    </div>
                </div>

                <!-- –°—Ä–æ–∫–∏ –∏ –≥–∞—Ä–∞–Ω—Ç–∏–∏ -->
                <h4>‚è∞ –°—Ä–æ–∫–∏ –∏ –≥–∞—Ä–∞–Ω—Ç–∏–∏</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="deadline">–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                        <input type="date" id="deadline" name="deadline">
                    </div>
                    <div class="form-group">
                        <label for="warranty_period_months">–ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Å—Ä–æ–∫ (–º–µ—Å—è—Ü—ã)</label>
                        <input type="number" id="warranty_period_months" name="warranty_period_months">
                    </div>
                    <div class="form-group">
                        <label for="payment_terms_days">–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã (–¥–Ω–∏)</label>
                        <input type="number" id="payment_terms_days" name="payment_terms_days">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="penalties">–®—Ç—Ä–∞—Ñ—ã –∏ –Ω–µ—É—Å—Ç–æ–π–∫–∏</label>
                        <textarea id="penalties" name="penalties"></textarea>
                    </div>
                </div>

                <button type="submit" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä</button>
            </form>
            <div id="contractResult"></div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤ -->
        <div class="form-section">
            <h3>üìä 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ã</h3>
            <button type="button" class="btn btn-secondary" onclick="loadContracts()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            <div id="contractsList"></div>
        </div>
    </div>

    <script>
        // OCR Form Handler
        document.getElementById('ocrForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                document.getElementById('ocrResult').innerHTML = '<p>‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...</p>';
                
                const response = await fetch('/test-ocr', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    document.getElementById('ocrResult').innerHTML = `
                        <div class="result success">
                            <h4>‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω—ã</h4>
                            <p><strong>–§–∞–π–ª:</strong> ${result.filename}</p>
                            <p><strong>–†–∞–∑–º–µ—Ä:</strong> ${result.file_size} –±–∞–π—Ç</p>
                            <button onclick="fillExtractedData(${JSON.stringify(result.entities).replace(/"/g, '&quot;')})" class="btn">
                                üìã –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                            </button>
                            <details style="margin-top: 10px;">
                                <summary>–ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç</summary>
                                <pre style="max-height: 200px; overflow: auto; background: #f8f9fa; padding: 10px; margin-top: 10px;">${result.extracted_text}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    document.getElementById('ocrResult').innerHTML = `
                        <div class="result error">
                            <h4>‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏</h4>
                            <p>${result.extracted_text || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('ocrResult').innerHTML = `
                    <div class="result error">
                        <h4>‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        });

        // Contract Form Handler
        document.getElementById('contractForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const contractData = {};
            
            for (let [key, value] of formData.entries()) {
                if (value.trim() !== '') {
                    if (key.includes('amount') || key.includes('rate') || key.includes('percentage') || key.includes('months') || key.includes('days')) {
                        contractData[key] = parseFloat(value) || null;
                    } else {
                        contractData[key] = value;
                    }
                }
            }

            try {
                document.getElementById('contractResult').innerHTML = '<p>‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞...</p>';
                
                const response = await fetch('/test-contract-save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(contractData)
                });

                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('contractResult').innerHTML = `
                        <div class="result success">
                            <h4>‚úÖ –î–æ–≥–æ–≤–æ—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω</h4>
                            <p>${result.message}</p>
                            <p><strong>–§–∞–π–ª:</strong> ${result.data.filename}</p>
                            <p><strong>–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ø–æ–ª–µ–π:</strong> ${result.data.saved_fields}</p>
                        </div>
                    `;
                    loadContracts(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    document.getElementById('contractResult').innerHTML = `
                        <div class="result error">
                            <h4>‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</h4>
                            <p>${result.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('contractResult').innerHTML = `
                    <div class="result error">
                        <h4>‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        });

        // Fill sample data
        function fillSampleData() {
            document.getElementById('number').value = '03.07/24-–ö';
            document.getElementById('contract_date').value = '2024-07-03';
            document.getElementById('customer_name').value = '–û–û–û "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è –õ–∏–¥–µ—Ä"';
            document.getElementById('contractor_name').value = '–û–û–û "–ê–¢–õ–ê–ù–¢"';
            document.getElementById('subject').value = '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Ñ–∞—Å–∞–¥–∞ —Å–µ–∫—Ü–∏–∏ ‚Ññ1, ‚Ññ9';
            document.getElementById('amount').value = '4728960.00';
            document.getElementById('vat_rate').value = '20';
            document.getElementById('retention_percentage').value = '5';
            document.getElementById('work_object_name').value = '–°—Ä–µ–¥–Ω–µ—ç—Ç–∞–∂–Ω—ã–π –∂–∏–ª–æ–π –¥–æ–º —Å–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ –Ω–µ–∂–∏–ª—ã–º–∏ –ø–æ–º–µ—â–µ–Ω–∏—è–º–∏';
            document.getElementById('work_object_address').value = '–≥. –°–∞–º–∞—Ä–∞, –û–∫—Ç—è–±—Ä—å—Å–∫–∏–π —Ä–∞–π–æ–Ω, –ø—Ä–æ—Å–µ–∫–∞ –¢—Ä–µ—Ç—å—è';
            document.getElementById('cadastral_number').value = '63:01:0637003:94';
            document.getElementById('construction_permit').value = '63-301000-130-2021';
            document.getElementById('warranty_period_months').value = '60';
            document.getElementById('payment_terms_days').value = '30';
            document.getElementById('penalties').value = '0.1% –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –ø–µ—Ä–≤—ã–µ 7 –¥–Ω–µ–π, 0.2% –Ω–∞—á–∏–Ω–∞—è —Å 8-–≥–æ –¥–Ω—è';
        }

        // Fill extracted data
        function fillExtractedData(entities) {
            if (entities.contract_number) document.getElementById('number').value = entities.contract_number;
            if (entities.contract_date) {
                // –ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
                const dateStr = entities.contract_date.replace(/[¬´¬ª]/g, '').trim();
                if (dateStr.includes('2024')) {
                    document.getElementById('contract_date').value = '2024-07-03';
                }
            }
            if (entities.customer_name) document.getElementById('customer_name').value = entities.customer_name;
            if (entities.contractor_name) document.getElementById('contractor_name').value = entities.contractor_name;
            if (entities.work_object_name) document.getElementById('work_object_name').value = entities.work_object_name;
            if (entities.work_object_address) document.getElementById('work_object_address').value = entities.work_object_address;
            if (entities.cadastral_number) document.getElementById('cadastral_number').value = entities.cadastral_number;
            if (entities.construction_permit) document.getElementById('construction_permit').value = entities.construction_permit;
            if (entities.amount_including_vat) document.getElementById('amount').value = entities.amount_including_vat;
            if (entities.vat_rate) document.getElementById('vat_rate').value = entities.vat_rate;
            if (entities.retention_percentage) document.getElementById('retention_percentage').value = entities.retention_percentage;
            if (entities.warranty_period_months) document.getElementById('warranty_period_months').value = entities.warranty_period_months;
        }

        // Load contracts list
        async function loadContracts() {
            try {
                document.getElementById('contractsList').innerHTML = '<p>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤...</p>';
                
                const response = await fetch('/test-contracts');
                const result = await response.json();
                
                if (result.success && result.data.contracts.length > 0) {
                    let html = '<h4>üìã –ù–∞–π–¥–µ–Ω–æ –¥–æ–≥–æ–≤–æ—Ä–æ–≤: ' + result.data.contracts.length + '</h4>';
                    
                    result.data.contracts.forEach(contract => {
                        html += `
                            <div class="contract-item">
                                <h4>üìÑ ${contract.contract_number}</h4>
                                <p><strong>–î–∞—Ç–∞:</strong> ${contract.contract_date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                                <p><strong>–ó–∞–∫–∞–∑—á–∏–∫:</strong> ${contract.customer_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                <p><strong>–ü–æ–¥—Ä—è–¥—á–∏–∫:</strong> ${contract.contractor_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                <p><strong>–°—É–º–º–∞:</strong> ${contract.amount ? contract.amount + ' —Ä—É–±.' : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                                <button onclick="loadContractDetails('${contract.contract_number}')" class="btn">
                                    üëÅÔ∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏
                                </button>
                            </div>
                        `;
                    });
                    
                    document.getElementById('contractsList').innerHTML = html;
                } else {
                    document.getElementById('contractsList').innerHTML = '<p>üì≠ –ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤</p>';
                }
            } catch (error) {
                document.getElementById('contractsList').innerHTML = `
                    <div class="result error">
                        <h4>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Load contract details
        async function loadContractDetails(contractNumber) {
            try {
                const response = await fetch(`/test-contract/${encodeURIComponent(contractNumber)}`);
                const result = await response.json();
                
                if (result.success) {
                    const details = JSON.stringify(result.data, null, 2);
                    alert(`–î–µ—Ç–∞–ª–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ ${contractNumber}:\n\n${details}`);
                } else {
                    alert(`–û—à–∏–±–∫–∞: ${result.message}`);
                }
            } catch (error) {
                alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`);
            }
        }

        // Load contracts on page load
        window.addEventListener('load', function() {
            loadContracts();
        });
    </script>
</body>
</html>